---
import Layout from "../layouts/Layout.astro";
import background from "../assets/background.svg";

// Build-time fetch: downloads stats from two function app endpoints using the x-functions-key header.

interface Stat {
  rowKey: string;
  creditTotal: number;
  creditToday: string;
  creditThisWeek: number;
  creditThisMonth: number;
  creditThisYear: number;
  latestTaskDownloadTime: string;
  timestamp: string;
}

interface Stats {
  projectStats: Record<string, Stat> | null;
  hostStats: Record<string, Stat> | null;
}

// Formatting helper functions
const formatNumber = (value: number | undefined): string => {
  if (value === undefined) return "";
  const rounded = Math.round(value);
  return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
};

const formatTimestamp = (timestamp: string): string => {
  if (!timestamp) return "";

  try {
    const date = new Date(timestamp);
    // Check if date is invalid or is Unix epoch (Jan 1, 1970)
    if (isNaN(date.getTime()) || date.getFullYear() === 1970) {
      return "";
    }
    return date.toLocaleString("hu-HU", {
      year: "numeric",
      month: "numeric",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
  } catch {
    return "";
  }
};

const FUNCTION_APP_URI = import.meta.env.FUNCTION_APP_URI;
const FUNCTIONS_KEY = import.meta.env.X_FUNCTIONS_KEY;

// Stats object will be available to the template at build time.
let stats: Stats = { projectStats: null, hostStats: null };

if (!FUNCTION_APP_URI || !FUNCTIONS_KEY) {
  console.warn(
    "FunctionAppUri or x-functions-key not set; skipping build-time fetch for function app stats."
  );
} else {
  try {
    const fetchStats = async (endpoint: string) => {
      const url = `${FUNCTION_APP_URI}/api/${endpoint}`;
      const response = await fetch(url, {
        headers: { "x-functions-key": FUNCTIONS_KEY },
      });
      return response.ok
        ? { ok: true, data: await response.json() }
        : { ok: false, url };
    };

    // Fetch latest stats
    const [hostResult, projectResult] = await Promise.all([
      fetchStats("hoststats"),
      fetchStats("projectstats"),
    ]);

    if (hostResult.ok) {
      const hostData = hostResult.data;
      // Calculate total row
      const hostValues = Object.values(hostData) as Stat[];
      const hostTotal: Stat = {
        rowKey: "Total",
        creditTotal: hostValues.reduce((sum, stat) => sum + stat.creditTotal, 0),
        creditToday: hostValues.reduce((sum, stat) => sum + Number(stat.creditToday), 0).toString(),
        creditThisWeek: hostValues.reduce((sum, stat) => sum + stat.creditThisWeek, 0),
        creditThisMonth: hostValues.reduce((sum, stat) => sum + stat.creditThisMonth, 0),
        creditThisYear: hostValues.reduce((sum, stat) => sum + stat.creditThisYear, 0),
        latestTaskDownloadTime: "",
        timestamp: ""
      };
      // Put Total first
      stats.hostStats = { "_total": hostTotal, ...hostData };
    } else {
      console.warn("Failed to fetch host stats:", hostResult.url);
    }

    if (projectResult.ok) {
      const projectData = projectResult.data;
      // Calculate total row
      const projectValues = Object.values(projectData) as Stat[];
      const projectTotal: Stat = {
        rowKey: "Total",
        creditTotal: projectValues.reduce((sum, stat) => sum + stat.creditTotal, 0),
        creditToday: projectValues.reduce((sum, stat) => sum + Number(stat.creditToday), 0).toString(),
        creditThisWeek: projectValues.reduce((sum, stat) => sum + stat.creditThisWeek, 0),
        creditThisMonth: projectValues.reduce((sum, stat) => sum + stat.creditThisMonth, 0),
        creditThisYear: projectValues.reduce((sum, stat) => sum + stat.creditThisYear, 0),
        latestTaskDownloadTime: "",
        timestamp: ""
      };
      // Put Total first
      stats.projectStats = { "_total": projectTotal, ...projectData };
    } else {
      console.warn("Failed to fetch project stats:", projectResult.url);
    }
  } catch (err) {
    console.error("Error fetching function app stats:", err);
  }
}
---

<Layout>
  <div class="page-container">
    <div class="content" id="content">
      <img id="background" src={background.src} alt="" fetchpriority="high" />
      <h1 id="title">BOINC watcher</h1>
      <section style="padding:1rem 0">
        {
          stats.projectStats || stats.hostStats ? (
            <div style="display:grid;gap:2rem">
              {stats.hostStats && (
                <div>
                  <h2>Host Stats</h2>
                  <div style="overflow-x:auto">
                    <table class="sortable-table" data-table="host">
                      <thead>
                        <tr style="background:#0969da;color:#fff">
                          <th data-sort="string" class="sortable">
                            Host Name <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Total Credit <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits Today <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits This Week <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits This Month <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits This Year <span class="sort-indicator" />
                          </th>
                          <th data-sort="date" class="sortable">
                            Latest task download <span class="sort-indicator" />
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(stats.hostStats)
                          .sort(([keyA], [keyB]) => {
                            if (keyA === "_total") return -1;
                            if (keyB === "_total") return 1;
                            return 0;
                          })
                          .map(([key, value]) => {
                          const isTotal = key === "_total";
                          return (
                            <tr
                              style={isTotal
                                ? "background:#f0f0f0;font-weight:600;border-top:2px solid #0969da"
                                : "border-bottom:1px solid #d0d7de"}
                            >
                              <td>{value.rowKey}</td>
                              <td
                                data-value={value.creditTotal}
                                style="text-align:right"
                              >
                                {formatNumber(value.creditTotal)}
                              </td>
                              <td
                                data-value={value.creditToday}
                                style="text-align:right"
                              >
                                {formatNumber(Number(value.creditToday))}
                              </td>
                              <td
                                data-value={value.creditThisWeek}
                                style="text-align:right"
                              >
                                {formatNumber(value.creditThisWeek)}
                              </td>
                              <td
                                data-value={value.creditThisMonth}
                                style="text-align:right"
                              >
                                {formatNumber(value.creditThisMonth)}
                              </td>
                              <td
                                data-value={value.creditThisYear}
                                style="text-align:right"
                              >
                                {formatNumber(value.creditThisYear)}
                              </td>
                              <td data-value={value.latestTaskDownloadTime}>
                                {formatTimestamp(value.latestTaskDownloadTime)}
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {stats.projectStats && (
                <div>
                  <h2>Project Stats</h2>
                  <div style="overflow-x:auto">
                    <table class="sortable-table" data-table="project">
                      <thead>
                        <tr style="background:#0969da;color:#fff">
                          <th data-sort="string" class="sortable">
                            Project Name <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Total Credit <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits Today <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits This Week <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits This Month <span class="sort-indicator" />
                          </th>
                          <th
                            data-sort="number"
                            class="sortable"
                            style="text-align:right"
                          >
                            Credits This Year <span class="sort-indicator" />
                          </th>
                          <th data-sort="date" class="sortable">
                            Latest task download <span class="sort-indicator" />
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(stats.projectStats)
                          .sort(([keyA], [keyB]) => {
                            if (keyA === "_total") return -1;
                            if (keyB === "_total") return 1;
                            return 0;
                          })
                          .map(
                          ([key, value]) => {
                            const isTotal = key === "_total";
                            return (
                              <tr
                                style={isTotal
                                  ? "background:#f0f0f0;font-weight:600;border-top:2px solid #0969da"
                                  : "border-bottom:1px solid #d0d7de"}
                              >
                                <td>{value.rowKey}</td>
                                <td
                                  data-value={value.creditTotal}
                                  style="text-align:right"
                                >
                                  {formatNumber(value.creditTotal)}
                                </td>
                                <td
                                  data-value={value.creditToday}
                                  style="text-align:right"
                                >
                                  {formatNumber(Number(value.creditToday))}
                                </td>
                                <td
                                  data-value={value.creditThisWeek}
                                  style="text-align:right"
                                >
                                  {formatNumber(value.creditThisWeek)}
                                </td>
                                <td
                                  data-value={value.creditThisMonth}
                                  style="text-align:right"
                                >
                                  {formatNumber(value.creditThisMonth)}
                                </td>
                                <td
                                  data-value={value.creditThisYear}
                                  style="text-align:right"
                                >
                                  {formatNumber(value.creditThisYear)}
                                </td>
                                <td data-value={value.latestTaskDownloadTime}>
                                  {formatTimestamp(value.latestTaskDownloadTime)}
                                </td>
                              </tr>
                            );
                          }
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <p>
              <em>
                No Function App stats available at build time. Ensure
                `FunctionAppUri` and `x-functions-key` are set.
              </em>
            </p>
          )
        }
      </section>
    </div>
  </div>

  <style is:global>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", Roboto, sans-serif;
    }

    table {
      border-collapse: collapse;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #000000;
      width: 100%;
      font-size: 0.85rem;
    }

    td,
    th {
      padding: 0.35rem 0.5rem;
      border: 1px solid #e1e4e8;
    }

    th {
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background-color: #f6f8fa;
    }

    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    .page-container {
      position: relative;
      min-height: 100vh;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      opacity: 0.95;
    }

    .content {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 900px;
    }

    #title,
    h2 {
      margin: 0 0 1rem 0;
      color: #ffffff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.9);
    }

    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      filter: blur(100px);
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    th.sortable:hover {
      background-color: #0550ae;
    }

    .sort-indicator {
      margin-left: 0.5rem;
      display: inline-block;
      width: 0.75rem;
    }

    .sort-indicator::after {
      content: "○";
      opacity: 0.3;
    }

    th.sortable[data-order="asc"] .sort-indicator::after {
      content: "▲";
      opacity: 1;
    }

    th.sortable[data-order="desc"] .sort-indicator::after {
      content: "▼";
      opacity: 1;
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tables = document.querySelectorAll(".sortable-table");

      tables.forEach((table) => {
        const headers = table.querySelectorAll("th.sortable");
        const tbody = table.querySelector("tbody");

        headers.forEach((header, columnIndex) => {
          header.addEventListener("click", () => {
            const sortType = (header as HTMLElement).dataset.sort;
            const currentOrder =
              (header as HTMLElement).dataset.order || "none";
            const newOrder = currentOrder === "asc" ? "desc" : "asc";

            // Remove sorting from other headers
            headers.forEach((h) => delete (h as HTMLElement).dataset.order);
            (header as HTMLElement).dataset.order = newOrder;

            // Get rows and sort
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll("tr"));
            
            // Separate Total row from other rows
            const totalRow = rows.find(row => {
              const firstCell = row.children[0] as HTMLElement;
              return firstCell.textContent?.trim() === "Total";
            });
            const dataRows = rows.filter(row => {
              const firstCell = row.children[0] as HTMLElement;
              return firstCell.textContent?.trim() !== "Total";
            });
            
            // Sort only data rows
            dataRows.sort((a, b) => {
              const cellA = a.children[columnIndex] as HTMLElement;
              const cellB = b.children[columnIndex] as HTMLElement;

              let valueA, valueB;

              if (sortType === "number") {
                valueA = parseFloat(cellA.dataset.value || "0") || 0;
                valueB = parseFloat(cellB.dataset.value || "0") || 0;
              } else if (sortType === "date") {
                valueA = new Date(cellA.dataset.value || 0).getTime();
                valueB = new Date(cellB.dataset.value || 0).getTime();
              } else {
                valueA = cellA.textContent?.trim().toLowerCase() || "";
                valueB = cellB.textContent?.trim().toLowerCase() || "";
              }

              if (valueA < valueB) return newOrder === "asc" ? -1 : 1;
              if (valueA > valueB) return newOrder === "asc" ? 1 : -1;
              return 0;
            });

            // Reappend Total row first, then sorted data rows
            if (totalRow) tbody.appendChild(totalRow);
            dataRows.forEach((row) => tbody.appendChild(row));
          });
        });
      });
    });
  </script>
</Layout>
