---
import Layout from "../layouts/Layout.astro";
import background from "../assets/background.svg";

// Build-time fetch: downloads stats from two function app endpoints using the x-functions-key header.

const FUNCTION_APP_URI = import.meta.env.FUNCTION_APP_URI;
const FUNCTIONS_KEY = import.meta.env.X_FUNCTIONS_KEY;

// Stats object will be available to the template at build time.
let stats = { projectStats: null, hostStats: null };

if (!FUNCTION_APP_URI || !FUNCTIONS_KEY) {
  console.warn(
    "FunctionAppUri or x-functions-key not set; skipping build-time fetch for function app stats."
  );
} else {
  try {
    // Build yyyyMMdd date parameter for the request
    const d = new Date();
    const pad = (n: number) => String(n).padStart(2, "0");
    const dateStr = `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}`;

    // Update these paths if your functions expose different routes.
    const hostStatsUrl = `${FUNCTION_APP_URI}/api/hoststats/${dateStr}`;
    const projectStatsUrl = `${FUNCTION_APP_URI}/api/projectstats/${dateStr}`;

    const [hostStats, projectStats] = await Promise.all([
      fetch(hostStatsUrl, { headers: { "x-functions-key": FUNCTIONS_KEY } }),
      fetch(projectStatsUrl, { headers: { "x-functions-key": FUNCTIONS_KEY } }),
    ]);

    if (hostStats.ok) {
      stats.hostStats = await hostStats.json();
    } else {
      console.warn("Failed to fetch", hostStatsUrl, "status", hostStats.status);
    }
    if (projectStats.ok) {
      stats.projectStats = await projectStats.json();
    } else {
      console.warn(
        "Failed to fetch",
        projectStatsUrl,
        "status",
        projectStats.status
      );
    }
  } catch (err) {
    console.error("Error fetching function app stats:", err);
  }
}
---

<Layout>
  <div class="page-container">
    <div class="content" id="content">
      <img id="background" src={background.src} alt="" fetchpriority="high" />
      <h1 id="title">BOINC watcher</h1>
      <section style="padding:1rem 0">
        {
          stats.projectStats || stats.hostStats ? (
            <div style="display:grid;gap:2rem">
              {stats.hostStats && (
                <div>
                  <h2>Host Stats</h2>
                  <div style="overflow-x:auto">
                    <table>
                      <thead>
                        <tr style="background:#0969da;color:#fff">
                          <th>Host Name</th>
                          <th>Total Credit</th>
                          <th>RAC</th>
                          <th>Latest task download</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(stats.hostStats).map(([key, value]) => (
                          <tr style="border-bottom:1px solid #d0d7de">
                            <td>{value.rowKey}</td>
                            <td>{value.totalCredit}</td>
                            <td>{value.rac}</td>
                            <td>{value.latestTaskDownloadTime}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {stats.projectStats && (
                <div>
                  <h2>Project Stats</h2>
                  <div style="overflow-x:auto">
                      <table>
                      <thead>
                        <tr style="background:#0969da;color:#fff">
                          <th>Project Name</th>
                          <th>Total Credit</th>
                          <th>RAC</th>
                          <th>Latest task download</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(stats.projectStats).map(([key, value]) => (
                          <tr style="border-bottom:1px solid #d0d7de">
                            <td>{value.rowKey}</td>
                            <td>{value.totalCredit}</td>
                            <td>{value.rac}</td>
                            <td>{value.latestTaskDownloadTime}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <p>
              <em>
                No Function App stats available at build time. Ensure
                `FunctionAppUri` and `x-functions-key` are set.
              </em>
            </p>
          )
        }
      </section>
    </div>
  </div>

  <style is:global>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Segoe UI", Roboto, sans-serif;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 4px;
      overflow: hidden;
    }

    .page-container {
      position: relative; /* for overlay pseudo-element */
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      opacity: 0.6;
    }

    .content {
      position: relative;
      z-index: 1;
      max-width: 900px;
      width: 100%;
    }

    #title, h2 {
      margin: 0 0 1rem 0;
      color: #ffffff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.9);
    }

    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      filter: blur(100px);
    }
  </style>
</Layout>
