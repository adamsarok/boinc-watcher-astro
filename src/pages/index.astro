---
import Layout from "../layouts/Layout.astro";
import background from "../assets/background.svg";

// Build-time fetch: downloads stats from two function app endpoints using the x-functions-key header.
// Environment variables used (read from process.env at build time):
// - FunctionAppUri (base URI for the Function App, e.g. https://my-functions.azurewebsites.net)
// - x-functions-key (function key for authentication)

// @ts-ignore: process is provided by the build environment
const env = (globalThis as any).process?.env ?? {};
const FunctionAppUri = env.FunctionAppUri;
const FUNCTIONS_KEY = env["x-functions-key"];

// Stats object will be available to the template at build time.
let stats = { projectStats: null, hostStats: null };

if (!FunctionAppUri || !FUNCTIONS_KEY) {
  console.warn(
    "FunctionAppUri or x-functions-key not set; skipping build-time fetch for function app stats."
  );
} else {
  try {
    // Normalize base URI (no trailing slash)
    const base = FunctionAppUri.replace(/\/$/, "");

    // Build yyyyMMdd date parameter for the request
    const d = new Date();
    const pad = (n: number) => String(n).padStart(2, "0");
    const dateStr = `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}`;

    // Update these paths if your functions expose different routes.
    const hostStatsUrl = `${base}/api/hoststats/${dateStr}`;
    const projectStatsUrl = `${base}/api/projectstats/${dateStr}`;

    const [hostStats, projectStats] = await Promise.all([
      fetch(hostStatsUrl, { headers: { "x-functions-key": FUNCTIONS_KEY } }),
      fetch(projectStatsUrl, { headers: { "x-functions-key": FUNCTIONS_KEY } }),
    ]);

    console.log(hostStatsUrl);
    console.log(projectStatsUrl);

    if (hostStats.ok) {
      stats.projectStats = await hostStats.json();
    } else {
      console.warn("Failed to fetch", hostStatsUrl, "status", hostStats.status);
    }
    if (projectStats.ok) {
      stats.hostStats = await projectStats.json();
    } else {
      console.warn(
        "Failed to fetch",
        projectStatsUrl,
        "status",
        projectStats.status
      );
    }
    console.log(stats);
  } catch (err) {
    console.error("Error fetching function app stats:", err);
  }
}
---

<Layout>
  <style>
    body {
      background-image: url({background.src});
    }
  </style>
  <div class="page-container">
    <div class="content" id="content">
      <h1 id="title">BOINC watcher</h1>
      <section style="padding:1rem 0">
        {
          stats.projectStats || stats.hostStats ? (
            <pre style="background:#f6f8fa;padding:1rem;border-radius:4px;overflow:auto">
              {JSON.stringify(stats, null, 2)}
            </pre>
          ) : (
            <p>
              <em>
                No Function App stats available at build time. Ensure
                `FunctionAppUri` and `x-functions-key` are set.
              </em>
            </p>
          )
        }
      </section>
    </div>
  </div>
</Layout>
